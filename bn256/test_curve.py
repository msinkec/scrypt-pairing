import os
import json
import random

from scryptlib import (
        compile_contract, build_contract_class, build_type_classes, Sig
        )

# We use mister Buterins BN128 imlementation: https://github.com/ethereum/py_pairing
from py_ecc import bn128



if __name__ == '__main__':
    contract = 'testCurve.scrypt' 

    compiler_result = compile_contract(contract, debug=False)
    desc = compiler_result.to_desc()

    # Load desc instead:
    #with open('./out/testCurve_desc.json', 'r') as f:
    #    desc = json.load(f)

    type_classes = build_type_classes(desc)
    CurvePoint = type_classes['CurvePoint']
    TwistPoint = type_classes['TwistPoint']

    BN256CurveTest = build_contract_class(desc)
    bn256_curve_test = BN256CurveTest()

    assert bn256_curve_test.testMulFQ2(
        [3405987990548047266285113383219237375681208871336813088616720519859893290134,1097898363339025022619935773355466049707129377218109808632059205990511152495],
        [15830831802146768141237429417912648980608634485983879601502329719750329240910,17600223279572061457933096596049532983114752208629637134127581753862971379897],
        [13280456509302578120643211182778528028445008769070598400682486420300123382757,14077784831528911634874593541487249727922369879397996051239784098410438328913]
    ).verify()

    assert bn256_curve_test.testMulFQ2(
        [2105949740918914271063060105651059047460421027348448486594564918154771860041,7208877007268361263057405770448273475112041783806363014296774951734852085369],
        [10430039423184564997462271628464346688096335645121092027654136556673260830422,2799353695224389898488658176425253066859548401343314072983449794730044616840],
        [21158591738682076599638557511778046142659168645991996733335023337715484387262,10726908656447904775952145913657767139169072279906216760789214831406461465222]
    ).verify()

    assert bn256_curve_test.testSquareFQ2(
        [10164919993845888976671999787039108309239529043666519144065145175600019709494,15683256606647490518785263877633372276865645512106721863554218588333290209773],
        [17716346817668547898162895567898312367694994438385561530353133167613592559022,749864555281199384965917972403867944977631700788046722647372737976621316898]
    ).verify()

    assert bn256_curve_test.testSquareFQ2(
        [19144803157775278375159214991808770972199362191093019402310641453501381025905,16446063910291131587708796740164098404410454097985448112522177643751361268548],
        [13281746305287042580201749504728912103367391312590007531435309421806045723870,10607158569612045664768872322411272349032031201412280681690286780254028051669]
    ).verify()

    assert bn256_curve_test.testInvFQ2(
        [12663726281075052576529495445555233084042548599504779355532284358480159563264,16917274543618607638879329582985454648863990160135520144890278124310018978736],
        [19933770970579907078333995283070161635300178294043109376243005639132530396374,20223262398611830173189782858380965369898070481705127844627698905560703728637]
    ).verify()

    assert bn256_curve_test.testInvFQ2(
        [2052813411379716806235723156424559943938583125432754199617746434996707713042,15620931015604026000042387094780759873793284514400320915957021197407947202637],
        [12635521097006000412927971235813000722393121407338074671576732785491229027785,4637679684128228996969231133835363570799044502926418616344576372644025384724]
    ).verify()

    # These are non affine coords.
    assert bn256_curve_test.testDoubleCurvePoint(
        CurvePoint({
            'x': 73788687783923572865529582504907608155214956439395813334735191320569125178503,
            'y': -122496500026268596728444203481896352677017027832972886303288710168393500005538,
            'z': 22987206675677772134801294288308330334594402809416658852345367183449639863912,
            't': 0
        }),
        CurvePoint({
            'x': 40094083719719619393940766425357327271087026231038327347555625854824010145758,
            'y': -9852071347415463562096344803767073482118243750295290563405771220847022942556,
            'z': 4329070336545105456186058296779459015225317083929127465725029105803417163430,
            't': 0
        })
    ).verify()

    assert bn256_curve_test.testDoubleCurvePoint(
        CurvePoint({
            'x': 58933191654204430737755350825707727871323471599138817260555591417335411077303,
            'y': -92253652949023445357391447639148093225242895481141910891359486284248895776654,
            'z': 41389450358466649992045910955401514822421155557957604256660981114399918309620,
            't': 0
        }),
        CurvePoint({
            'x': -22554907915555176350414532685275495628984729186445329361110645191135298832515,
            'y': -31750153302866858947412513189842729468562533856814599153904194585421437479826,
            'z': 7534918716301660006808367044150199408346011511926217932276215521046299265354,
            't': 0
        })
    ).verify()

    assert bn256_curve_test.testAddCurvePoints(
        CurvePoint({
            'x': -35390452869298637112488933694426790652442594116821618451180389231471007425452,
            'y': -6490513048170728222706017446130359059994637236813609840630884093800788303151,
            'z': 20139939579536595913240503788590498159668308368538632155876609166890909225923,
            't': 0
        }),
        CurvePoint({
            'x': 35795802497547527817808855434523126280073030131181877489882412374201501260009,
            'y': -82949508411743709219775852956283281164774390393008273133518327917030414687567,
            'z': 25669920468901608656135782549488099258458532883262993039712356496940744056154,
            't': 0
        }),
        CurvePoint({
            'x': -17074470727979385113415987325580287400653009212241198764596378074597878613722,
            'y': -28830552005025113116427610177374917747492322467562256138950885722750851786561,
            'z': 1452172047100442523711748697750195030836423197603084104488756753986115379591,
            't': 0
        })
    ).verify()

    assert bn256_curve_test.testAddCurvePoints(
        CurvePoint({
            'x': 29553149906910695719791222001045778584925908674542136349193872176195517328265,
            'y': -85385622986228964465663027385316708852734498311801234253397233906429876803337,
            'z': 10784377178629024445507589335108283669452020808671692422391104558997985100674,
            't': 0
        }),
        CurvePoint({
            'x': 65009169066220450843182678699145269739718695304088763427975856814450840234477,
            'y': -68529941283186109390562472977748515530318890604843776084932019871347372389499,
            'z': 3747318957881019499007836509519063530142499150940739495000500630123492896290,
            't': 0
        }),
        CurvePoint({
            'x': -21669532904408586641859911338644481048613871217980485578938607720160366501644,
            'y': -23799320082236174435746520850388517274527057167887457841371974280183685237619,
            'z': 10564883135751132081352506237115321495100553200609754850888583741595829041081,
            't': 0
        })
    ).verify()

    assert bn256_curve_test.testAddCurvePoints(
        CurvePoint({
            'x': 29553149906910695719791222001045778584925908674542136349193872176195517328265,
            'y': -85385622986228964465663027385316708852734498311801234253397233906429876803337,
            'z': 10784377178629024445507589335108283669452020808671692422391104558997985100674,
            't': 0
        }),
        CurvePoint({
            'x': 321398129,
            'y': 231823921,
            'z': 0,
            't': 0
        }),
        CurvePoint({
            'x': 29553149906910695719791222001045778584925908674542136349193872176195517328265,
            'y': -85385622986228964465663027385316708852734498311801234253397233906429876803337,
            'z': 10784377178629024445507589335108283669452020808671692422391104558997985100674,
            't': 0
        })
    ).verify()

    assert bn256_curve_test.testDoubleTwistPoint(
        TwistPoint({
            'x': [21803299162587159093130539135145572807795477038447859432540751666484243307378,14160860808659624249791923184273513169703174217701411061287126131901744717498],
            'y': [12348842028229527927984596899602338811809816732921741315631576031212187963091,17310412403653152045013908897709123660398369538993156495992160294826644645233],
            'z': [20774818994662033435979198413857540484448616573599419839855281583195546892327,535529033384374083048290923006644333452078437126654646357241140108514831052],
            't': [0, 0]
        }),
        TwistPoint({
            'x': [6154120496737182535843941759912921837251889019147348372743609794794594575517,20343099075496000029367136106681574468475178367614549992267283912865778511191],
            'y': [3860659214181981426876568840183046228355791281029146899213143718556470997471,18752030443051705345103812975067210769586171571602936930905682438346180900896],
            'z': [994142384327483794385252714698816763457266949805037581576304568305013988569,3517218440415198116295168589113211807526855704597195354208391607748753570264],
            't': [0, 0]
        })
    ).verify()

    assert bn256_curve_test.testDoubleTwistPoint(
        TwistPoint({
            'x': [10692980601154232698052417109801168097107324781917836347884773283916055051935,10747996821828955391536312430950463875110582177103053777435664174076715437522],
            'y': [5906496073256916493878677789661063974259687105675193881140110294780893187636,1019134537207350837795475215274407213102093116189608845924353602816978883527],
            'z': [21737828510582337707832272276442301918165139659383932409114193599460736419882,1232947655903866840765426346660974584919479613414431186466710547746911751051],
            't': [0, 0]
        }),
        TwistPoint({
            'x': [15597717313126326188873415110056205025994950031996531670171897602080742969422,13210680665942259717158242830622700249537519908388754730066772253577311571715],
            'y': [2871864950513423158911395404670890088718092401008385534298209138823998109084,14132742657972709171085761210323414761985333397520886041325298954514604633620],
            'z': [18571597904418655166345235704812178412720324127612026874355915602440901799892,15934848564084313647950420862453981801836496730730338952936488226817088297286],
            't': [0, 0]
        })
    ).verify()

    assert bn256_curve_test.testAddTwistPoints(
        TwistPoint({
            'x': [21543646204422859627907522335982125739198596835577860935580612524332189294526,19843969139118009808260853385090318589194585427652520048140408229907348391020],
            'y': [12036362144693348177935207956745108114991489044843250558345211614739651641319,19709788014625088882938549530179745704321186285054147926156320852188010461769],
            'z': [617337779726246679479160887153342995153789079082540260509866592273607634630,15199475983944404328534823046086543592046651656142526960843238390241767203631],
            't': [0, 0]
        }),
        TwistPoint({
            'x': [5623412977715420717614336639145790208048496744354823128872389178904358896261,15053001804424406478579500390563501252761118404036013293257054558408739913352],
            'y': [14078288237848054142653631928069436303178782254733970848398811380001495673756,21377027782325019215160195713681310211339870959709298189076532633686108595936],
            'z': [12817279162010280786074781558993530227155444878026436839637767051516610371524,7642354845021129677756215807048781998587383523084156369990041384138937319441],
            't': [0, 0]
        }),
        TwistPoint({
            'x': [19537152266093774233425428424457040938124656072530128255951902068041293053859,2097410323072878836200846759604990538852374941870736472813354317065998560186],
            'y': [17338264928037143723979188784345874126421075549129482343960905565273877673415,15282740453121938101243619140258455877304969237111086293654442337616963127315],
            'z': [8019279314528893165450947001743065455284122174463480699019212192572802786127,12854066983792483143075848663429715773712844191710255051773630455046726015538],
            't': [0, 0]
        })
    ).verify()

    assert bn256_curve_test.testAddTwistPoints(
        TwistPoint({
            'x': [11923015240339839928884867232870780544687848196519173340380304689177455753165,19061345941082766957090081248431970742749156645845366306852110186241741066206],
            'y': [1717646181375146883181568103879457597206541916964772771098203523183538475347,13708680416711183184941804992784369338667958361399735444836276641858577838588],
            'z': [15930634546111176624522499517405553264264893215324415641960096369939836670611,10332875634879161951919782591602350624091513394786804360129664657534125386130],
            't': [0, 0]
        }),
        TwistPoint({
            'x': [20917198477910295129888380774800086963655600968917959043819630702800887749031,9040951486572923965993194068824659624982089406174527459464575114723754423129],
            'y': [25641641585394079283748911620285755251628972512575390683742479428833253811,9268749391445676449014652995629455767041793207747573460823749014988573929160],
            'z': [11764705262643292996224409779912613966013620943945490967351202262638017586852,18342799058679680482800970189681256589706008713419085352398557596775793807457],
            't': [0, 0]
        }),
        TwistPoint({
            'x': [11911032117887479105235452443469469536855155882520295304136723279421261221615,847236599478602503184512484806609432358667850740976135890523921619676572114],
            'y': [16915248512906614981536326659915637342776417498527226991958029107193365724595,11619315951596687412045400251386811769699042318558451318858786692324318497226],
            'z': [8779907950310112161780366269845498716612360919579883636527163093048488770489,8711105243152773109295858344039369461167648500171901737976741914441173235433],
            't': [0, 0]
        })
    ).verify()

